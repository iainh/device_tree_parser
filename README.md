# Device Tree Parser

A Rust library for parsing device tree files, supporting both binary Device Tree Blob (DTB) format and device tree source files. This library is designed for embedded systems and provides `no_std` compatibility with `alloc` support.

## Features

- **Binary DTB Parsing**: Parse Device Tree Blob files with full structure validation
- **Memory Reservation Support**: Handle memory reservation blocks in DTB files
- **Property Interpolation**: Support for device tree property value parsing and interpolation
- **Iterator Interface**: Convenient tree traversal with `NodeIterator`
- **No-std Compatible**: Works in embedded environments with heap allocation
- **Integration Tested**: Validated against real QEMU-generated DTB files

## Installation

Add this to your `Cargo.toml`:

```toml
[dependencies]
device_tree_parser = "0.1.0"
```

## Usage

### Basic DTB Parsing

```rust
use device_tree_parser::{DeviceTreeParser, DtbHeader};

// Load your DTB data
let dtb_data = std::fs::read("path/to/your.dtb")?;

// Create a parser
let parser = DeviceTreeParser::new(&dtb_data);

// Parse the header
let (_remaining, header) = DtbHeader::parse(&dtb_data)?;
println!("DTB Version: {}", header.version());
```

### Tree Traversal

```rust
use device_tree_parser::{DeviceTreeParser, NodeIterator};

let dtb_data = std::fs::read("your.dtb")?;
let parser = DeviceTreeParser::new(&dtb_data);

// Iterate through device tree nodes
for node in parser.nodes() {
    println!("Node: {}", node.name());
    
    // Access properties
    for property in node.properties() {
        println!("  Property: {} = {:?}", property.name(), property.value());
    }
}
```

## Building

### Prerequisites

This project uses:
- Rust 2024 edition
- Nix flake for reproducible development environment (optional)

### Build Commands

```bash
# Build the library
cargo build

# Build with release optimizations
cargo build --release

# Quick syntax checking
cargo check
```

### Development Environment (Nix)

If you have Nix installed, you can use the provided flake:

```bash
# Enter development shell
nix develop

# Or run commands directly
nix run .#cargo -- build
```

## Testing

### Unit Tests

```bash
# Run all tests
cargo test

# Run specific test
cargo test test_parser_creation

# Compile tests without running
cargo test --no-run
```

### Integration Tests

The project includes integration tests using real DTB files generated by QEMU:

```bash
# Run integration tests specifically
cargo test integration_tests

# Run tests with output
cargo test -- --nocapture
```

### Test Data

Test data is located in `test-data/` and includes:
- `virt.dtb`: QEMU virtual machine device tree for testing

## Code Quality

```bash
# Format code
cargo fmt

# Run lints (if clippy is available)
cargo clippy
```

## Architecture

The library is structured as follows:

- `src/lib.rs` - Main library interface and public API
- `src/dtb/` - Device Tree Blob parsing implementation
  - `header.rs` - DTB header parsing and validation
  - `parser.rs` - Core DTB parsing logic
  - `tokens.rs` - DTB token structure parsing
  - `tree.rs` - Device tree node and property structures
  - `memory.rs` - Memory reservation block handling
  - `error.rs` - Error types and handling
- `src/parser.rs` - General parsing utilities
- `src/integration_tests.rs` - Real-world DTB parsing tests

## API Reference

### Main Types

- `DeviceTreeParser` - Main parser interface
- `DtbHeader` - Device tree blob header
- `DeviceTreeNode` - Individual device tree nodes
- `Property` - Device tree properties
- `PropertyValue` - Typed property values
- `MemoryReservation` - Memory reservation entries
- `NodeIterator` - Iterator for tree traversal

### Error Handling

The library uses `DtbError` for comprehensive error reporting during parsing operations.

## No-std Support

This library is `no_std` compatible and only requires `alloc` for heap allocation. It's suitable for embedded systems and bare-metal environments.

## Contributing

1. Ensure all tests pass: `cargo test`
2. Format code: `cargo fmt`
3. Run lints: `cargo clippy`
4. Follow the existing code style and patterns
5. Add tests for new functionality

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Changelog

- v0.1.0 - Initial release with DTB parsing support
  - Binary DTB format parsing
  - Memory reservation block support
  - Device tree traversal and property access
  - Integration tests with QEMU DTB data